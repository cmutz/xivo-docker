#!/bin/bash

SERVICES="rsyslog postgresql ssh spawn-fcgi nginx \
          rabbitmq-server xivo-sysconfd xivo-confgend \
          xivo-dxtora xivo-provd xivo-agid asterisk \
          xivo-amid xivo-call-logs xivo-agent \
          xivo-ctid xivo-restapi"

DATADIR="/var/lib/postgresql/9.1/main"

function init {
    echo "Creating Postgres data at $DATADIR"
    su - postgres -c "psql template1 < /tmp/asterisk.sql"
    xivo-init-db --drop --init
}

function start {
    for service in $SERVICES
    do
        echo "Launch $service ..."
        service $service start
    done
}

start

if [ ! -d $DATADIR ]; then
    init
fi
